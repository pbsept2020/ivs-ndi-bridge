<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://web-broadcast.live-video.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https://*.amazonaws.com wss://*.live-video.net https://*.live-video.net;">
    <title>IVS-NDI Bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://web-broadcast.live-video.net/1.24.0/amazon-ivs-web-broadcast.js"></script>
    <style>
:root {
    --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px; --space-2xl: 48px;
    --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-size-xs: 11px; --font-size-sm: 13px; --font-size-base: 15px; --font-size-lg: 18px; --font-size-xl: 24px;
    --radius-sm: 6px; --radius-md: 8px; --radius-lg: 12px; --radius-full: 9999px;
    --transition-fast: 150ms ease; --transition-base: 250ms ease;
    --z-sticky: 200; --z-modal: 300;
}
[data-theme="dark"] {
    --color-bg: #09090b; --color-bg-elevated: #18181b; --color-bg-subtle: #27272a; --color-bg-muted: #3f3f46;
    --color-text: #fafafa; --color-text-secondary: #a1a1aa; --color-text-muted: #71717a;
    --color-border: #27272a; --color-border-subtle: #3f3f46;
    --color-primary: #3b82f6; --color-primary-hover: #60a5fa; --color-primary-muted: rgba(59, 130, 246, 0.15);
    --color-success: #22c55e; --color-success-muted: rgba(34, 197, 94, 0.15);
    --color-warning: #f59e0b; --color-warning-muted: rgba(245, 158, 11, 0.15);
    --color-danger: #ef4444; --color-danger-muted: rgba(239, 68, 68, 0.15);
    --color-ndi: #00d4aa; --color-ndi-hover: #00e4ba; --color-ndi-muted: rgba(0, 212, 170, 0.15);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3); --shadow-md: 0 4px 12px rgba(0,0,0,0.4); --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
    --shadow-glow-ndi: 0 0 20px rgba(0, 212, 170, 0.3);
}
[data-theme="light"] {
    --color-bg: #ffffff; --color-bg-elevated: #f4f4f5; --color-bg-subtle: #e4e4e7; --color-bg-muted: #d4d4d8;
    --color-text: #18181b; --color-text-secondary: #52525b; --color-text-muted: #a1a1aa;
    --color-border: #e4e4e7; --color-border-subtle: #d4d4d8;
    --color-primary: #2563eb; --color-primary-hover: #3b82f6; --color-primary-muted: rgba(37, 99, 235, 0.1);
    --color-success: #16a34a; --color-success-muted: rgba(22, 163, 74, 0.1);
    --color-warning: #d97706; --color-warning-muted: rgba(217, 119, 6, 0.1);
    --color-danger: #dc2626; --color-danger-muted: rgba(220, 38, 38, 0.1);
    --color-ndi: #009980; --color-ndi-hover: #00b090; --color-ndi-muted: rgba(0, 153, 128, 0.1);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.08); --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --shadow-glow-ndi: 0 0 20px rgba(0, 153, 128, 0.2);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-font-smoothing: antialiased; }
body { font-family: var(--font-family); font-size: var(--font-size-base); line-height: 1.6; color: var(--color-text); background: var(--color-bg); min-height: 100vh; transition: background var(--transition-base), color var(--transition-base); }
.app { display: flex; flex-direction: column; min-height: 100vh; }
.container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 var(--space-md); }
.main { flex: 1; padding: var(--space-lg) 0; }

.titlebar { -webkit-app-region: drag; height: 38px; display: flex; align-items: center; justify-content: center; background: var(--color-bg); border-bottom: 1px solid var(--color-border); padding-left: 80px; }
.titlebar * { -webkit-app-region: no-drag; }
.titlebar-title { font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-muted); }

.navbar { position: sticky; top: 0; z-index: var(--z-sticky); background: var(--color-bg); border-bottom: 1px solid var(--color-border); backdrop-filter: blur(12px); }
.navbar-inner { display: flex; align-items: center; justify-content: space-between; height: 64px; gap: var(--space-lg); }
.navbar-brand { display: flex; align-items: center; gap: var(--space-sm); font-size: var(--font-size-lg); font-weight: 700; color: var(--color-text); text-decoration: none; }
.navbar-logo { width: 32px; height: 32px; background: linear-gradient(135deg, var(--color-ndi), #00a080); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; font-size: var(--font-size-xs); }
.navbar-center { flex: 1; display: flex; justify-content: center; }
.navbar-status { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); background: var(--color-bg-elevated); border-radius: var(--radius-full); font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.navbar-actions { display: flex; align-items: center; gap: var(--space-sm); }

.status-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--color-text-muted); transition: all var(--transition-base); }
.status-indicator.connected { background: var(--color-ndi); box-shadow: 0 0 8px var(--color-ndi); }
.status-indicator.connecting { background: var(--color-warning); animation: pulse 1.5s ease-in-out infinite; }
.status-indicator.error { background: var(--color-danger); }
@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } }

.platform-info { display: flex; gap: var(--space-sm); font-size: var(--font-size-xs); }
.platform-badge { padding: 4px 8px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-muted); }
.platform-badge.ndi { background: var(--color-ndi-muted); border-color: var(--color-ndi); color: var(--color-ndi); }
.platform-badge.ndi.error { background: var(--color-danger-muted); border-color: var(--color-danger); color: var(--color-danger); }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); font-family: inherit; font-size: var(--font-size-sm); font-weight: 500; line-height: 1; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); white-space: nowrap; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--color-primary); color: white; }
.btn-primary:hover:not(:disabled) { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn-danger { background: var(--color-danger); color: white; }
.btn-danger:hover:not(:disabled) { filter: brightness(1.1); }
.btn-ghost { background: transparent; color: var(--color-text-secondary); border-color: var(--color-border); }
.btn-ghost:hover:not(:disabled) { background: var(--color-bg-elevated); color: var(--color-text); }
.btn-ndi { background: linear-gradient(135deg, var(--color-ndi), #00a080); color: #000; font-weight: 600; }
.btn-ndi:hover:not(:disabled) { background: linear-gradient(135deg, var(--color-ndi-hover), #00b090); transform: translateY(-1px); box-shadow: var(--shadow-glow-ndi); }
.btn-icon { width: 40px; height: 40px; padding: 0; border-radius: var(--radius-md); }
.btn-lg { padding: var(--space-md) var(--space-xl); font-size: var(--font-size-base); border-radius: var(--radius-lg); }

.card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); }
.card-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--color-border); }
.card-title { font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.card-body { padding: var(--space-lg); }

.collapsible { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); margin-bottom: var(--space-md); overflow: hidden; }
.collapsible.ndi-accent { border-color: var(--color-ndi); box-shadow: var(--shadow-glow-ndi); }
.collapsible-trigger { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: var(--space-md) var(--space-lg); background: transparent; border: none; cursor: pointer; font-family: inherit; font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-secondary); text-align: left; transition: all var(--transition-fast); }
.collapsible-trigger:hover { background: var(--color-bg-subtle); color: var(--color-text); }
.collapsible-trigger-content { display: flex; align-items: center; gap: var(--space-sm); }
.collapsible-icon { width: 20px; height: 20px; transition: transform var(--transition-fast); }
.collapsible.open .collapsible-icon { transform: rotate(90deg); }
.collapsible-badge { padding: 2px 8px; background: var(--color-bg-muted); border-radius: var(--radius-full); font-size: var(--font-size-xs); color: var(--color-text-muted); }
.collapsible-badge.active { background: var(--color-ndi-muted); color: var(--color-ndi); }
.collapsible-content { display: none; padding: var(--space-lg); border-top: 1px solid var(--color-border); }
.collapsible.open .collapsible-content { display: block; }

.form-group { display: flex; flex-direction: column; gap: var(--space-xs); }
.form-label { font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-secondary); }
.form-input, .form-select { width: 100%; padding: var(--space-sm) var(--space-md); font-family: inherit; font-size: var(--font-size-sm); color: var(--color-text); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md); transition: all var(--transition-fast); }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-muted); }
.form-row { display: grid; gap: var(--space-md); }
.form-row-2 { grid-template-columns: repeat(2, 1fr); }

.duration-presets { display: flex; gap: var(--space-xs); margin-top: var(--space-sm); }
.duration-presets button { flex: 1; padding: 6px; font-size: var(--font-size-xs); background: var(--color-bg-muted); color: var(--color-text); border: none; border-radius: var(--radius-full); cursor: pointer; transition: all var(--transition-fast); }
.duration-presets button:hover { background: var(--color-bg-subtle); }
.duration-presets button.active { background: var(--color-primary); color: white; }

.ndi-status-grid { display: flex; gap: var(--space-md); flex-wrap: wrap; }
.ndi-sender-card { background: var(--color-ndi-muted); border: 1px solid var(--color-ndi); border-radius: var(--radius-md); padding: var(--space-sm) var(--space-md); min-width: 180px; }
.ndi-sender-name { color: var(--color-ndi); font-weight: 600; font-size: var(--font-size-sm); }
.ndi-sender-stats { color: var(--color-text-muted); font-size: var(--font-size-xs); margin-top: 2px; }
.ndi-empty { color: var(--color-text-muted); font-size: var(--font-size-sm); font-style: italic; }

.video-section { margin-top: var(--space-lg); }
.video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--space-md); }
.video-card { position: relative; aspect-ratio: 16/9; background: var(--color-bg-elevated); border: 2px solid var(--color-border); border-radius: var(--radius-lg); overflow: hidden; transition: all var(--transition-fast); }
.video-card.combined { border-color: var(--color-success); }
.video-card.ndi-active { border-color: var(--color-ndi); box-shadow: var(--shadow-glow-ndi); }
.video-card video { width: 100%; height: 100%; object-fit: cover; background: #000; }

.video-overlay { position: absolute; bottom: var(--space-md); left: var(--space-md); display: flex; align-items: center; gap: var(--space-sm); }
.video-name { padding: 6px 12px; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: 500; color: white; display: flex; align-items: center; gap: var(--space-sm); }
.audio-indicator { width: 16px; height: 16px; background: var(--color-text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
.audio-indicator.active { background: var(--color-success); animation: pulse 1s infinite; }

.quality-indicator { position: absolute; top: var(--space-sm); right: var(--space-sm); background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--font-size-xs); color: var(--color-success); }

.ndi-badge { position: absolute; top: var(--space-sm); left: var(--space-sm); background: linear-gradient(135deg, var(--color-ndi), #00a080); color: #000; padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: 700; letter-spacing: 0.5px; display: none; animation: ndi-glow 2s infinite; }
.ndi-badge.active { display: block; }
.ndi-badge .fps { font-weight: normal; margin-left: 4px; }
@keyframes ndi-glow { 0%, 100% { box-shadow: 0 0 5px rgba(0, 212, 170, 0.5); } 50% { box-shadow: 0 0 15px rgba(0, 212, 170, 0.8); } }

.video-overlay-controls { position: absolute; bottom: 50px; left: var(--space-sm); display: flex; gap: var(--space-sm); opacity: 0; transition: opacity var(--transition-fast); }
.video-card:hover .video-overlay-controls { opacity: 1; }
.video-overlay-controls button { background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); border: none; color: white; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-full); cursor: pointer; font-size: var(--font-size-sm); display: flex; align-items: center; gap: var(--space-xs); transition: all var(--transition-fast); }
.video-overlay-controls button:hover { background: rgba(0,0,0,0.9); transform: scale(1.05); }
.video-overlay-controls button.ndi-btn { background: var(--color-ndi-muted); border: 1px solid var(--color-ndi); }
.video-overlay-controls button.ndi-btn:hover { background: rgba(0, 212, 170, 0.4); }
.video-overlay-controls button.ndi-btn.active { background: var(--color-ndi); color: #000; }

.empty-state { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-2xl); text-align: center; }
.empty-state-icon { width: 64px; height: 64px; margin-bottom: var(--space-md); color: var(--color-text-muted); opacity: 0.5; }
.empty-state-text { color: var(--color-text-muted); max-width: 300px; }
.empty-state-subtext { font-size: var(--font-size-sm); color: var(--color-text-muted); margin-top: var(--space-sm); opacity: 0.7; }

.controls-bar { display: flex; gap: var(--space-sm); justify-content: center; flex-wrap: wrap; padding: var(--space-md); background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); margin-top: var(--space-md); }

.log-panel { max-height: 200px; overflow-y: auto; padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md); font-family: 'SF Mono', Monaco, Consolas, monospace; font-size: var(--font-size-xs); }
.log-entry { padding: 3px 0; color: var(--color-text-secondary); }
.log-entry.info { color: var(--color-primary); }
.log-entry.success { color: var(--color-success); }
.log-entry.error { color: var(--color-danger); background: var(--color-danger-muted); padding: 3px 6px; border-radius: 4px; }
.log-entry.warning { color: var(--color-warning); }
.log-entry.ndi { color: var(--color-ndi); }

.status-message { padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); font-size: var(--font-size-sm); margin-top: var(--space-md); text-align: center; display: none; }
.status-message.visible { display: block; }
.status-message.loading { background: var(--color-primary-muted); color: var(--color-primary); border: 1px solid var(--color-primary); }
.status-message.success { background: var(--color-success-muted); color: var(--color-success); border: 1px solid var(--color-success); }
.status-message.error { background: var(--color-danger-muted); color: var(--color-danger); border: 1px solid var(--color-danger); }

.theme-toggle { background: var(--color-bg-elevated); border: 1px solid var(--color-border); }
.theme-toggle:hover { background: var(--color-bg-subtle); }

.footer { padding: var(--space-md) 0; border-top: 1px solid var(--color-border); margin-top: var(--space-lg); }
.footer-inner { display: flex; align-items: center; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-text-muted); }

/* Context Menu */
.context-menu { position: fixed; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-xs) 0; min-width: 200px; box-shadow: var(--shadow-lg); z-index: 1000; font-size: var(--font-size-sm); }
.context-menu-item { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); cursor: pointer; transition: background var(--transition-fast); color: var(--color-text); }
.context-menu-item:hover { background: var(--color-bg-subtle); }
.context-menu-item.disabled { opacity: 0.5; cursor: not-allowed; }
.context-menu-item.disabled:hover { background: transparent; }
.context-menu-separator { height: 1px; background: var(--color-border); margin: var(--space-xs) 0; }
.context-menu-submenu { position: relative; }
.context-menu-submenu::after { content: '‚ñ∂'; position: absolute; right: var(--space-md); font-size: 10px; opacity: 0.5; }
.context-menu-submenu .context-menu { display: none; position: absolute; left: 100%; top: -4px; }
.context-menu-submenu:hover .context-menu { display: block; }
.projector-badge { position: absolute; top: var(--space-sm); right: 50px; background: var(--color-primary-muted); border: 1px solid var(--color-primary); color: var(--color-primary); padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: 600; display: none; }
.projector-badge.active { display: block; }

@media (max-width: 768px) {
    .navbar-center { display: none; }
    .form-row-2 { grid-template-columns: 1fr; }
    .video-grid { grid-template-columns: 1fr; }
    .controls-bar { flex-direction: column; }
    .controls-bar .btn { width: 100%; }
}
    </style>
</head>
<body>
    <div class="app">
        <div class="titlebar"><span class="titlebar-title">IVS-NDI Bridge</span></div>

        <nav class="navbar">
            <div class="container">
                <div class="navbar-inner">
                    <a href="#" class="navbar-brand">
                        <div class="navbar-logo">NDI</div>
                        <span>IVS-NDI Bridge</span>
                    </a>
                    <div class="navbar-center">
                        <div class="navbar-status">
                            <div class="status-indicator" id="statusIndicator"></div>
                            <span id="statusText">D√©connect√©</span>
                            <span id="participantCount" style="margin-left: 8px; opacity: 0.7;">‚Ä¢ 0 source(s)</span>
                        </div>
                    </div>
                    <div class="navbar-actions">
                        <div class="platform-info" id="platformInfo"><span class="platform-badge">Chargement...</span></div>
                        <button class="btn btn-icon theme-toggle" onclick="toggleTheme()" title="Changer de th√®me"><span id="themeIcon">‚òÄÔ∏è</span></button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="main">
            <div class="container">
                <div class="collapsible ndi-accent open" id="ndiPanel">
                    <button class="collapsible-trigger" onclick="toggleCollapsible('ndiPanel')">
                        <span class="collapsible-trigger-content">
                            <svg class="collapsible-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            <span>üì° Sorties NDI</span>
                        </span>
                        <span class="collapsible-badge" id="ndiBadgeCount">0 actif</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="form-group" style="margin-bottom: var(--space-md);">
                            <label class="form-label">üéöÔ∏è Jitter Buffer: <span id="jitterValue">0</span>ms</label>
                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-muted);">0</span>
                                <input type="range" id="jitterSlider" min="0" max="300" value="0" style="flex: 1; accent-color: var(--color-ndi);" oninput="updateJitterBuffer(this.value)">
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-muted);">300</span>
                            </div>
                            <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 4px;">0 = direct (pas de buffer), augmenter pour lisser un flux instable</div>
                        </div>
                        <div class="ndi-status-grid" id="ndiStatusGrid"><span class="ndi-empty">Connectez-vous √† un stage pour activer les sorties NDI</span></div>
                    </div>
                </div>

                <div class="collapsible open" id="connectionPanel">
                    <button class="collapsible-trigger" onclick="toggleCollapsible('connectionPanel')">
                        <span class="collapsible-trigger-content">
                            <svg class="collapsible-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            <span>‚ö° Connexion au Stage</span>
                        </span>
                        <span class="collapsible-badge" id="connectionBadge">D√©connect√©</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="form-row form-row-2">
                            <div class="form-group">
                                <label class="form-label" for="stageSelect">Stage</label>
                                <select class="form-select" id="stageSelect"><option value="">-- Chargement des stages... --</option></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="userIdInput">User ID</label>
                                <input type="text" class="form-input" id="userIdInput" placeholder="bridge-operator" value="bridge-operator">
                            </div>
                        </div>
                        <div class="collapsible" id="advancedConfig" style="margin-top: var(--space-md);">
                            <button class="collapsible-trigger" onclick="toggleCollapsible('advancedConfig')">
                                <span class="collapsible-trigger-content">
                                    <svg class="collapsible-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                                    <span>‚öôÔ∏è Options avanc√©es</span>
                                </span>
                            </button>
                            <div class="collapsible-content">
                                <div class="form-row form-row-2">
                                    <div class="form-group">
                                        <label class="form-label" for="durationInput">Dur√©e du token (minutes)</label>
                                        <input type="number" class="form-input" id="durationInput" value="120" min="1" max="1440">
                                        <div class="duration-presets">
                                            <button onclick="setDuration(60)">1h</button>
                                            <button onclick="setDuration(120)" class="active">2h</button>
                                            <button onclick="setDuration(240)">4h</button>
                                            <button onclick="setDuration(480)">8h</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="apiUrlInput">URL de l'API</label>
                                        <input type="text" class="form-input" id="apiUrlInput" value="https://8o76zphwpa.execute-api.eu-central-1.amazonaws.com/prod">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-sm); margin-top: var(--space-lg);">
                            <button class="btn btn-primary btn-lg" onclick="generateTokenFromApi()" id="btnGenerate" style="flex: 1;">üé´ G√©n√©rer Token</button>
                            <button class="btn btn-ndi btn-lg" onclick="generateAndConnect()" id="btnGenerateConnect" disabled style="flex: 1;">üöÄ Connecter</button>
                        </div>
                        <div id="apiStatus" class="status-message"></div>
                    </div>
                </div>

                <section class="video-section">
                    <div class="video-grid" id="videoGrid">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                            <p class="empty-state-text">Connectez-vous √† un stage IVS</p>
                            <p class="empty-state-subtext">Les participants seront disponibles en sortie NDI</p>
                        </div>
                    </div>
                </section>

                <div class="controls-bar">
                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectFromStage()" disabled>Se d√©connecter</button>
                    <button class="btn btn-ndi" onclick="startAllNDI()" id="startAllNdiBtn" disabled>üì° Activer tous les NDI</button>
                    <button class="btn btn-ghost" onclick="stopAllNDI()">‚èπ Arr√™ter tous les NDI</button>
                    <button class="btn btn-ghost" onclick="clearLogs()">üßπ Effacer logs</button>
                </div>

                <div class="card" style="margin-top: var(--space-md);">
                    <div class="card-header"><span class="card-title">Journal</span></div>
                    <div class="card-body"><div class="log-panel" id="logPanel"></div></div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <div class="footer-inner">
                    <span>IVS-NDI Bridge ‚Ä¢ WebRTC ‚Üí NDI</span>
                    <span id="currentUser"></span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const API_BASE_URL = 'https://8o76zphwpa.execute-api.eu-central-1.amazonaws.com/prod';
        let availableStages = [];
        let currentToken = null, tokenPayload = null, stage = null;
        let participants = new Map(), participantStreams = new Map();
        let ndiEnabled = new Map(), ndiCapture = new Map(), ndiAvailable = false;
        let jitterBufferMs = 0; // 0 = direct, pas de buffer
        let projectorEnabled = new Map(); // participantId -> boolean
        let availableDisplays = []; // Liste des √©crans disponibles
        
        // ==================== CONTEXT MENU ====================
        
        let activeContextMenu = null;
        
        function hideContextMenu() {
            if (activeContextMenu) {
                activeContextMenu.remove();
                activeContextMenu = null;
            }
        }
        
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', (e) => {
            // Fermer le menu si on clique ailleurs
            if (activeContextMenu && !activeContextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });
        
        async function showVideoContextMenu(e, participantId) {
            e.preventDefault();
            hideContextMenu();
            
            const participant = participants.get(participantId);
            const displayName = participant?.userId || participantId.slice(0, 8);
            const hasProjector = projectorEnabled.get(participantId);
            
            // R√©cup√©rer les √©crans disponibles
            if (window.bridge && window.bridge.projector) {
                availableDisplays = await window.bridge.projector.getDisplays();
            }
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.innerHTML = `
                <div class="context-menu-item" onclick="openProjectorWindowed('${participantId}', '${displayName}')">
                    ü™ü Projecteur fen√™tr√©
                </div>
                <div class="context-menu-submenu">
                    <div class="context-menu-item">üñ•Ô∏è Projecteur plein √©cran</div>
                    <div class="context-menu">
                        ${availableDisplays.map(d => `
                            <div class="context-menu-item" onclick="openProjectorFullscreen('${participantId}', '${displayName}', ${d.id})">
                                ${d.primary ? '‚≠ê ' : ''}${d.label} (${d.bounds.width}x${d.bounds.height})
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${hasProjector ? `
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="closeProjector('${participantId}')">
                    ‚ùå Fermer le projecteur
                </div>
                ` : ''}
            `;
            
            // Positionner le menu
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
            
            // Ajuster si le menu d√©passe de l'√©cran
            document.body.appendChild(menu);
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = `${window.innerWidth - rect.width - 10}px`;
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = `${window.innerHeight - rect.height - 10}px`;
            }
            
            activeContextMenu = menu;
        }
        
        // ==================== PROJECTOR FUNCTIONS ====================
        
        async function openProjectorWindowed(participantId, displayName) {
            hideContextMenu();
            if (!window.bridge || !window.bridge.projector) {
                log('‚ö†Ô∏è Projecteur non disponible (mode web)', 'warning');
                return;
            }
            
            if (!currentToken) {
                log('‚ùå Token requis pour le projecteur', 'error');
                return;
            }
            
            try {
                const result = await window.bridge.projector.open(participantId, displayName, null, true, currentToken);
                if (result.success) {
                    projectorEnabled.set(participantId, true);
                    updateProjectorBadge(participantId, true);
                    log(`ü™ü Projecteur fen√™tr√© ouvert: ${displayName} (WebRTC direct)`, 'info');
                }
            } catch (err) {
                log(`‚ùå Erreur ouverture projecteur: ${err.message}`, 'error');
            }
        }
        
        async function openProjectorFullscreen(participantId, displayName, displayId) {
            hideContextMenu();
            if (!window.bridge || !window.bridge.projector) {
                log('‚ö†Ô∏è Projecteur non disponible (mode web)', 'warning');
                return;
            }
            
            if (!currentToken) {
                log('‚ùå Token requis pour le projecteur', 'error');
                return;
            }
            
            try {
                const result = await window.bridge.projector.open(participantId, displayName, displayId, false, currentToken);
                if (result.success) {
                    projectorEnabled.set(participantId, true);
                    updateProjectorBadge(participantId, true);
                    log(`üñ•Ô∏è Projecteur plein √©cran ouvert: ${displayName} (WebRTC direct)`, 'info');
                }
            } catch (err) {
                log(`‚ùå Erreur ouverture projecteur: ${err.message}`, 'error');
            }
        }
        
        async function closeProjector(participantId) {
            hideContextMenu();
            if (!window.bridge || !window.bridge.projector) return;
            
            try {
                await window.bridge.projector.close(participantId);
                projectorEnabled.set(participantId, false);
                updateProjectorBadge(participantId, false);
                const participant = participants.get(participantId);
                log(`‚ùå Projecteur ferm√©: ${participant?.userId || participantId.slice(0, 8)}`, 'info');
            } catch (err) {
                log(`‚ùå Erreur fermeture projecteur: ${err.message}`, 'error');
            }
        }
        
        function updateProjectorBadge(participantId, active) {
            const badge = document.getElementById(`projector-badge-${participantId}`);
            if (badge) {
                badge.classList.toggle('active', active);
            }
        }
        
        // √âcouter les fermetures de projecteur depuis le main process
        if (window.bridge) {
            window.bridge.on('projector:closed', ({ participantId }) => {
                projectorEnabled.set(participantId, false);
                updateProjectorBadge(participantId, false);
                const participant = participants.get(participantId);
                log(`ü™ü Projecteur ferm√© (externe): ${participant?.userId || participantId?.slice(0, 8)}`, 'info');
            });
        }
        
        function updateJitterBuffer(value) {
            jitterBufferMs = parseInt(value) || 0;
            document.getElementById('jitterValue').textContent = jitterBufferMs;
            log(`üéöÔ∏è Jitter buffer: ${jitterBufferMs}ms${jitterBufferMs === 0 ? ' (direct)' : ''}`, 'ndi');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('ivs-ndi-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            log(`üé® Th√®me: ${newTheme === 'dark' ? 'sombre' : 'clair'}`, 'info');
        }

        function loadTheme() {
            const saved = localStorage.getItem('ivs-ndi-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            document.getElementById('themeIcon').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleCollapsible(id) { document.getElementById(id).classList.toggle('open'); }

        async function init() {
            loadTheme();
            log('üöÄ IVS-NDI Bridge d√©marr√©', 'info');
            if (window.bridge) {
                const platform = window.bridge.platform;
                document.getElementById('platformInfo').innerHTML = `
                    <span class="platform-badge">Electron ${platform.versions.electron}</span>
                    <span class="platform-badge">${platform.os}</span>
                    <span class="platform-badge ndi" id="ndiStatusBadge">NDI: Init...</span>`;
                log('üì° Initialisation NDI...', 'ndi');
                try {
                    ndiAvailable = await window.bridge.ndi.init();
                    if (ndiAvailable) {
                        log('‚úÖ NDI pr√™t - Grandiose charg√©', 'ndi');
                        document.getElementById('ndiStatusBadge').textContent = 'NDI ‚úì';
                    } else {
                        log('‚ö†Ô∏è NDI non disponible', 'warning');
                        document.getElementById('ndiStatusBadge').textContent = 'NDI ‚úó';
                        document.getElementById('ndiStatusBadge').classList.add('error');
                    }
                } catch (err) {
                    log(`‚ùå Erreur init NDI: ${err.message}`, 'error');
                    document.getElementById('ndiStatusBadge').textContent = 'NDI ‚úó';
                    document.getElementById('ndiStatusBadge').classList.add('error');
                }
            } else {
                log('‚ö†Ô∏è Mode navigateur - NDI d√©sactiv√©', 'warning');
                document.getElementById('platformInfo').innerHTML = `<span class="platform-badge">Mode Web</span><span class="platform-badge ndi error">NDI ‚úó</span>`;
            }
            await loadStages();
            setTimeout(() => {
                if (typeof IVSBroadcastClient !== 'undefined') log('‚úÖ SDK IVS charg√©', 'success');
                else log('‚ùå SDK IVS non trouv√©', 'error');
            }, 500);
        }

        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[IVS-NDI] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logPanel').innerHTML = '';
            log('üßπ Logs effac√©s', 'info');
        }

        function getApiUrl() { return document.getElementById('apiUrlInput')?.value || API_BASE_URL; }

        function showApiStatus(message, type) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = 'status-message visible ' + type;
        }

        function setDuration(minutes) {
            document.getElementById('durationInput').value = minutes;
            document.querySelectorAll('.duration-presets button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function loadStages() {
            try {
                log('üì° Chargement des stages...', 'info');
                const response = await fetch(`${getApiUrl()}/stages`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                availableStages = data.stages || [];
                const select = document.getElementById('stageSelect');
                select.innerHTML = '<option value="">-- S√©lectionnez un stage --</option>';
                availableStages.forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage.arn;
                    option.textContent = `${stage.name} (${stage.activeSessionId ? 'üü¢ Actif' : '‚ö™ Inactif'})`;
                    select.appendChild(option);
                });
                log(`‚úÖ ${availableStages.length} stage(s) disponible(s)`, 'success');
                document.getElementById('btnGenerateConnect').disabled = false;
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                document.getElementById('stageSelect').innerHTML = '<option value="">‚ùå Erreur chargement</option>';
            }
        }

        async function generateTokenFromApi() {
            const stageArn = document.getElementById('stageSelect').value;
            if (!stageArn) { showApiStatus('‚ö†Ô∏è S√©lectionnez un stage', 'error'); return null; }
            const userId = document.getElementById('userIdInput').value.trim() || 'bridge-operator';
            const duration = parseInt(document.getElementById('durationInput').value) || 120;
            try {
                showApiStatus('‚è≥ G√©n√©ration du token...', 'loading');
                document.getElementById('btnGenerate').disabled = true;
                const response = await fetch(`${getApiUrl()}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stageArn, userId, duration })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || `HTTP ${response.status}`); }
                const data = await response.json();
                currentToken = data.token;
                tokenPayload = JSON.parse(atob(currentToken.split('.')[1]));
                showApiStatus(`‚úÖ Token g√©n√©r√© (${duration} min)`, 'success');
                log(`üé´ Token: ${userId}`, 'success');
                document.getElementById('currentUser').textContent = `üë§ ${userId}`;
                return data.token;
            } catch (error) {
                showApiStatus(`‚ùå ${error.message}`, 'error');
                log(`‚ùå ${error.message}`, 'error');
                return null;
            } finally {
                document.getElementById('btnGenerate').disabled = false;
            }
        }

        async function generateAndConnect() {
            const token = await generateTokenFromApi();
            if (token) setTimeout(() => connectToStage(), 100);
        }

        function updateStatus(state) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const badge = document.getElementById('connectionBadge');
            indicator.classList.remove('connected', 'connecting', 'error');
            switch(state) {
                case 'CONNECTED':
                    indicator.classList.add('connected'); text.textContent = 'Connect√©'; badge.textContent = 'Connect√©'; badge.classList.add('active');
                    document.getElementById('disconnectBtn').disabled = false; document.getElementById('startAllNdiBtn').disabled = false; break;
                case 'CONNECTING':
                    indicator.classList.add('connecting'); text.textContent = 'Connexion...'; badge.textContent = 'Connexion...'; break;
                case 'DISCONNECTED':
                    text.textContent = 'D√©connect√©'; badge.textContent = 'D√©connect√©'; badge.classList.remove('active');
                    document.getElementById('disconnectBtn').disabled = true; document.getElementById('startAllNdiBtn').disabled = true; break;
                case 'ERROR':
                    indicator.classList.add('error'); text.textContent = 'Erreur'; badge.textContent = 'Erreur'; badge.classList.add('error'); break;
            }
        }

        function updateParticipantCount() { document.getElementById('participantCount').textContent = `‚Ä¢ ${participants.size} source(s)`; }

        function updateNDIPanel() {
            const grid = document.getElementById('ndiStatusGrid');
            const badgeCount = document.getElementById('ndiBadgeCount');
            const activeNDI = [];
            ndiEnabled.forEach((enabled, participantId) => {
                if (enabled) {
                    const participant = participants.get(participantId);
                    const capture = ndiCapture.get(participantId);
                    const fps = capture ? Math.round(capture.frameCount / ((Date.now() - capture.startTime) / 1000)) : 0;
                    activeNDI.push({ id: participantId, name: participant?.userId || participantId.slice(0, 8), fps, frames: capture?.frameCount || 0 });
                }
            });
            badgeCount.textContent = `${activeNDI.length} actif`;
            badgeCount.classList.toggle('active', activeNDI.length > 0);
            if (activeNDI.length === 0) {
                grid.innerHTML = '<span class="ndi-empty">Aucune sortie NDI active - Survolez une vid√©o et cliquez sur üì°</span>';
            } else {
                grid.innerHTML = activeNDI.map(ndi => `<div class="ndi-sender-card"><div class="ndi-sender-name">IVS-${ndi.name}</div><div class="ndi-sender-stats">${ndi.frames} frames ‚Ä¢ ${ndi.fps} fps</div></div>`).join('');
            }
        }

        function startFrameCapture(participantId) {
            const container = document.getElementById(`video-${participantId}-combined`);
            if (!container) { log(`‚ùå Container vid√©o non trouv√©: ${participantId}`, 'error'); return false; }
            const video = container.querySelector('video');
            if (!video || video.readyState < 2) { log(`‚ö†Ô∏è Vid√©o pas pr√™te: ${participantId}`, 'warning'); return false; }
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true, alpha: false });
            canvas.width = video.videoWidth || 1280; canvas.height = video.videoHeight || 720;
            log(`üìê Capture: ${canvas.width}x${canvas.height}`, 'ndi');
            const captureState = { 
                canvas, ctx, video, 
                frameCount: 0, 
                sentCount: 0, // Frames r√©ellement envoy√©es en NDI
                startTime: Date.now(), 
                intervalId: null,
                // Jitter buffer
                frameBuffer: [],
                sendIntervalId: null
            };
            ndiCapture.set(participantId, captureState);
            function captureFrame() {
                if (!ndiEnabled.get(participantId)) return;
                const state = ndiCapture.get(participantId);
                if (!state) return;
                
                // DIAGNOSTIC: Timing de chaque √©tape
                const t0 = performance.now();
                
                // V√©rifier si la vid√©o a une nouvelle frame
                if (state.video.readyState < 2) {
                    state.droppedFrames = (state.droppedFrames || 0) + 1;
                    return; // Video pas pr√™te
                }
                
                // D√©tecter changement de r√©solution
                if (state.video.videoWidth && state.canvas.width !== state.video.videoWidth) { 
                    state.canvas.width = state.video.videoWidth; 
                    state.canvas.height = state.video.videoHeight;
                    console.log(`[DIAG] R√©solution chang√©e: ${state.canvas.width}x${state.canvas.height}`);
                }
                
                const t1 = performance.now();
                state.ctx.drawImage(state.video, 0, 0, state.canvas.width, state.canvas.height);
                
                const t2 = performance.now();
                const imageData = state.ctx.getImageData(0, 0, state.canvas.width, state.canvas.height);
                
                const t3 = performance.now();
                
                const frameData = { width: state.canvas.width, height: state.canvas.height, data: new Uint8Array(imageData.data.buffer) };
                
                if (jitterBufferMs === 0) {
                    // Mode direct: envoyer imm√©diatement
                    window.bridge.ndi.sendFrame(participantId, frameData);
                    state.sentCount++;
                } else {
                    // Mode buffer: ajouter au buffer
                    state.frameBuffer.push(frameData);
                    // Limiter la taille du buffer (max ~jitterBufferMs de frames √† 25fps)
                    const maxFrames = Math.ceil(jitterBufferMs / 40) + 2;
                    while (state.frameBuffer.length > maxFrames) {
                        state.frameBuffer.shift(); // Supprimer les plus anciennes
                    }
                }
                
                const t4 = performance.now();
                state.frameCount++;
                
                // Accumuler les timings
                state.timings = state.timings || { drawImage: 0, getImageData: 0, sendFrame: 0, total: 0, samples: 0 };
                state.timings.drawImage += (t2 - t1);
                state.timings.getImageData += (t3 - t2);
                state.timings.sendFrame += (t4 - t3);
                state.timings.total += (t4 - t0);
                state.timings.samples++;
                
                // Log toutes les 150 frames (environ 6 secondes)
                if (state.frameCount % 150 === 0) {
                    const badge = document.getElementById(`ndi-badge-${participantId}`);
                    const elapsed = (Date.now() - state.startTime) / 1000;
                    const fps = Math.round(state.frameCount / elapsed);
                    const sentFps = Math.round(state.sentCount / elapsed);
                    if (badge) badge.innerHTML = `üì° NDI <span class="fps">${sentFps} fps</span>`;
                    
                    // Afficher diagnostics
                    const n = state.timings.samples;
                    const avgDraw = (state.timings.drawImage / n).toFixed(2);
                    const avgGet = (state.timings.getImageData / n).toFixed(2);
                    const avgSend = (state.timings.sendFrame / n).toFixed(2);
                    const avgTotal = (state.timings.total / n).toFixed(2);
                    const dropped = state.droppedFrames || 0;
                    
                    console.log(`[DIAG] ${state.canvas.width}x${state.canvas.height} @ ${fps}fps (sent: ${sentFps}fps) | drawImage:${avgDraw}ms getImageData:${avgGet}ms send:${avgSend}ms total:${avgTotal}ms | dropped:${dropped}`);
                    log(`‚è±Ô∏è cap:${fps}fps sent:${sentFps}fps | draw:${avgDraw}ms get:${avgGet}ms | buf:${state.frameBuffer.length}`, 'ndi');
                    
                    // Reset timings
                    state.timings = { drawImage: 0, getImageData: 0, sendFrame: 0, total: 0, samples: 0 };
                    state.droppedFrames = 0;
                    
                    updateNDIPanel();
                }
            }
            captureState.intervalId = setInterval(captureFrame, 40);
            
            // Sender loop s√©par√© pour le jitter buffer (envoie √† rythme constant)
            function sendFromBuffer() {
                const state = ndiCapture.get(participantId);
                if (!state || !ndiEnabled.get(participantId)) return;
                
                // En mode direct, rien √† faire ici
                if (jitterBufferMs === 0) return;
                
                // Mode buffer: envoyer une frame du buffer √† rythme r√©gulier
                if (state.frameBuffer.length > 0) {
                    // Attendre que le buffer soit suffisamment rempli avant de commencer
                    const targetFrames = Math.ceil(jitterBufferMs / 40);
                    if (state.frameBuffer.length >= targetFrames || state.frameCount > targetFrames * 2) {
                        const frame = state.frameBuffer.shift();
                        window.bridge.ndi.sendFrame(participantId, frame);
                        state.sentCount++;
                    }
                }
            }
            
            // D√©marrer le sender √† 25fps fixe
            captureState.sendIntervalId = setInterval(sendFromBuffer, 40);
            
            log(`‚ñ∂Ô∏è Capture d√©marr√©e: ${participantId.slice(0, 8)} (buffer: ${jitterBufferMs}ms)`, 'ndi');
            return true;
        }

        function stopFrameCapture(participantId) {
            const state = ndiCapture.get(participantId);
            if (state) {
                if (state.intervalId) clearInterval(state.intervalId);
                if (state.sendIntervalId) clearInterval(state.sendIntervalId);
                const fps = Math.round(state.frameCount / ((Date.now() - state.startTime) / 1000));
                log(`‚èπ Capture arr√™t√©e: ${state.frameCount} frames, ${fps} fps moyen`, 'ndi');
                ndiCapture.delete(participantId);
            }
        }

        async function toggleNDI(participantId) {
            const isEnabled = ndiEnabled.get(participantId);
            const participant = participants.get(participantId);
            const displayName = participant?.userId || participantId.slice(0, 8);
            if (!window.bridge) { log('‚ö†Ô∏è NDI non disponible (mode web)', 'warning'); return; }
            if (!ndiAvailable) { log('‚ö†Ô∏è NDI non initialis√©', 'warning'); return; }
            const ndiBtn = document.getElementById(`ndi-btn-${participantId}`);
            const ndiBadge = document.getElementById(`ndi-badge-${participantId}`);
            const container = document.getElementById(`video-${participantId}-combined`);
            if (isEnabled) {
                try {
                    stopFrameCapture(participantId);
                    await window.bridge.ndi.removeSender(participantId);
                    ndiEnabled.set(participantId, false);
                    ndiBtn?.classList.remove('active'); ndiBadge?.classList.remove('active'); container?.classList.remove('ndi-active');
                    log(`‚èπ NDI arr√™t√©: ${displayName}`, 'ndi');
                } catch (err) { log(`‚ùå Erreur arr√™t NDI: ${err.message}`, 'error'); }
            } else {
                try {
                    const senderName = await window.bridge.ndi.createSender(participantId, displayName);
                    if (senderName) {
                        ndiEnabled.set(participantId, true);
                        ndiBtn?.classList.add('active'); ndiBadge?.classList.add('active'); container?.classList.add('ndi-active');
                        const captureStarted = startFrameCapture(participantId);
                        if (captureStarted) log(`üì° NDI d√©marr√©: ${senderName}`, 'ndi');
                        else log(`‚ö†Ô∏è NDI cr√©√© mais capture √©chou√©e`, 'warning');
                    } else log(`‚ùå √âchec cr√©ation NDI`, 'error');
                } catch (err) { log(`‚ùå Erreur cr√©ation NDI: ${err.message}`, 'error'); }
            }
            updateNDIPanel();
        }

        async function startAllNDI() {
            log('üì° Activation de tous les NDI...', 'ndi');
            for (const [participantId] of participants) {
                if (!ndiEnabled.get(participantId)) { await toggleNDI(participantId); await new Promise(r => setTimeout(r, 200)); }
            }
        }

        async function stopAllNDI() {
            log('‚èπ Arr√™t de tous les NDI...', 'ndi');
            for (const [participantId] of participants) { if (ndiEnabled.get(participantId)) await toggleNDI(participantId); }
        }

        function combineStreams(participantId) {
            const streams = participantStreams.get(participantId);
            if (!streams || streams.combined) return streams?.combined;
            if (streams.audio && streams.video) {
                try {
                    const combinedStream = new MediaStream();
                    streams.video.getVideoTracks().forEach(track => combinedStream.addTrack(track));
                    streams.audio.getAudioTracks().forEach(track => combinedStream.addTrack(track));
                    streams.combined = combinedStream;
                    removeIndividualVideoContainers(participantId);
                    createCombinedVideoElement(participantId, combinedStream);
                    log(`‚úÖ Stream combin√©: ${participantId.slice(0, 8)}`, 'success');
                    return combinedStream;
                } catch (error) { log(`‚ùå Erreur combinaison: ${error.message}`, 'error'); }
            }
            return null;
        }

        function removeIndividualVideoContainers(participantId) {
            // Supprimer TOUS les √©l√©ments vid√©o de ce participant (audio, video, et tout autre)
            const grid = document.getElementById('videoGrid');
            const toRemove = grid.querySelectorAll(`[id^="video-${participantId}-"]`);
            console.log(`[Cleanup] Found ${toRemove.length} elements for ${participantId.slice(0,8)}`);
            toRemove.forEach(el => {
                console.log(`[Cleanup] Removing: ${el.id}`);
                el.remove();
            });
        }

        function createCombinedVideoElement(participantId, combinedStream) {
            const participant = participants.get(participantId);
            const container = document.createElement('div');
            container.className = 'video-card combined';
            container.id = `video-${participantId}-combined`;
            
            // Gestionnaire clic droit pour menu contextuel
            container.addEventListener('contextmenu', (e) => showVideoContextMenu(e, participantId));
            
            const video = document.createElement('video');
            video.autoplay = true; video.playsInline = true; video.muted = true;
            const ndiBadge = document.createElement('div');
            ndiBadge.className = 'ndi-badge'; ndiBadge.id = `ndi-badge-${participantId}`; ndiBadge.textContent = 'üì° NDI';
            
            // Badge projecteur
            const projectorBadge = document.createElement('div');
            projectorBadge.className = 'projector-badge'; 
            projectorBadge.id = `projector-badge-${participantId}`; 
            projectorBadge.textContent = 'ü™ü Proj';
            const overlayControls = document.createElement('div');
            overlayControls.className = 'video-overlay-controls';
            const ndiBtn = document.createElement('button');
            ndiBtn.className = 'ndi-btn'; ndiBtn.id = `ndi-btn-${participantId}`; ndiBtn.innerHTML = 'üì° NDI'; ndiBtn.title = 'Activer la sortie NDI';
            ndiBtn.onclick = (e) => { e.stopPropagation(); toggleNDI(participantId); };
            overlayControls.appendChild(ndiBtn);
            const qualityIndicator = document.createElement('div');
            qualityIndicator.className = 'quality-indicator'; qualityIndicator.textContent = 'HD';
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            const displayName = participant?.userId || participantId.slice(0, 8);
            const nameLabel = document.createElement('div');
            nameLabel.className = 'video-name';
            nameLabel.innerHTML = `<span class="audio-indicator active">üîä</span> ${displayName}`;
            overlay.appendChild(nameLabel);
            container.appendChild(video); container.appendChild(ndiBadge); container.appendChild(projectorBadge); container.appendChild(overlayControls); container.appendChild(qualityIndicator); container.appendChild(overlay);
            video.srcObject = combinedStream;
            video.addEventListener('loadedmetadata', () => {
                qualityIndicator.textContent = video.videoHeight >= 720 ? 'HD' : 'SD';
                log(`üì∫ R√©solution: ${video.videoWidth}x${video.videoHeight}`, 'info');
            });
            video.play().catch(() => { container.style.cursor = 'pointer'; container.addEventListener('click', () => video.play(), { once: true }); });
            const grid = document.getElementById('videoGrid');
            if (grid.querySelector('.empty-state')) grid.innerHTML = '';
            grid.appendChild(container);
            ndiEnabled.set(participantId, false);
            return container;
        }

        function createVideoElement(participantId, mediaStream, userId, streamType) {
            const container = document.createElement('div');
            container.className = 'video-card'; container.id = `video-${participantId}-${streamType}`;
            const video = document.createElement('video');
            video.autoplay = true; video.playsInline = true; video.muted = true;
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            const nameLabel = document.createElement('div');
            nameLabel.className = 'video-name';
            nameLabel.innerHTML = `<span class="audio-indicator ${streamType === 'audio' ? 'active' : ''}">${streamType === 'audio' ? 'üîä' : 'üé•'}</span> ${userId || participantId.slice(0, 8)} [${streamType}]`;
            overlay.appendChild(nameLabel);
            container.appendChild(video); container.appendChild(overlay);
            video.srcObject = mediaStream;
            video.play().catch(() => {});
            return container;
        }

        async function connectToStage() {
            if (!currentToken) { log('‚ùå Aucun token', 'error'); return; }
            if (typeof IVSBroadcastClient === 'undefined') { log('‚ùå SDK IVS non disponible', 'error'); return; }
            try {
                log('üîå Connexion au stage...', 'info');
                updateStatus('CONNECTING');
                const strategy = {
                    stageStreamsToPublish: () => [],
                    shouldPublishParticipant: () => false,
                    shouldSubscribeToParticipant: () => IVSBroadcastClient.SubscribeType.AUDIO_VIDEO
                };
                stage = new IVSBroadcastClient.Stage(currentToken, strategy);
                stage.on(IVSBroadcastClient.StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => { log(`üì° ${state}`, 'info'); updateStatus(state); });
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_JOINED, (participant) => {
                    log(`‚úÖ ${participant.userId || participant.id} a rejoint`, 'success');
                    participants.set(participant.id, participant);
                    if (!participantStreams.has(participant.id)) participantStreams.set(participant.id, { audio: null, video: null, combined: null });
                    updateParticipantCount();
                });
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_LEFT, (participant) => {
                    log(`üëã ${participant.userId || participant.id} est parti`, 'warning');
                    if (ndiEnabled.get(participant.id)) { stopFrameCapture(participant.id); if (window.bridge) window.bridge.ndi.removeSender(participant.id); }
                    participants.delete(participant.id); participantStreams.delete(participant.id); ndiEnabled.delete(participant.id); ndiCapture.delete(participant.id);
                    document.querySelectorAll(`[id^="video-${participant.id}"]`).forEach(el => el.remove());
                    updateParticipantCount(); updateNDIPanel();
                    if (participants.size === 0) {
                        document.getElementById('videoGrid').innerHTML = `<div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg><p class="empty-state-text">En attente de participants...</p></div>`;
                    }
                });
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED, (participant, streams) => {
                    log(`üé• Flux de ${participant.userId || participant.id}: ${streams.length} stream(s)`, 'info');
                    const grid = document.getElementById('videoGrid');
                    if (grid.querySelector('.empty-state')) grid.innerHTML = '';
                    streams.forEach((stream) => {
                        const mediaStreamTrack = stream.mediaStreamTrack;
                        if (!mediaStreamTrack) return;
                        const mediaStream = new MediaStream([mediaStreamTrack]);
                        const streamType = mediaStreamTrack.kind;
                        log(`üé¨ Track ${streamType}: ${mediaStreamTrack.label}`, 'info');
                        const data = participantStreams.get(participant.id) || { audio: null, video: null, combined: null };
                        data[streamType] = mediaStream;
                        participantStreams.set(participant.id, data);
                        const videoElement = createVideoElement(participant.id, mediaStream, participant.userId, streamType);
                        grid.appendChild(videoElement);
                    });
                    setTimeout(() => {
                        const streamData = participantStreams.get(participant.id);
                        if (streamData?.audio && streamData?.video && !streamData?.combined) combineStreams(participant.id);
                    }, 1500);
                });
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_STREAMS_REMOVED, (participant, streams) => {
                    log(`üóëÔ∏è Streams supprim√©s: ${participant.id}`, 'warning');
                    streams.forEach(stream => { document.getElementById(`video-${participant.id}-${stream.mediaStreamTrack?.kind}`)?.remove(); });
                    document.getElementById(`video-${participant.id}-combined`)?.remove();
                });
                stage.on(IVSBroadcastClient.StageEvents.ERROR, (error) => { log(`‚ùå ${error.message || error}`, 'error'); updateStatus('ERROR'); });
                await stage.join();
            } catch (error) { log(`‚ùå Connexion: ${error.message}`, 'error'); updateStatus('ERROR'); }
        }

        async function disconnectFromStage() {
            if (!stage) return;
            try {
                log('üîå D√©connexion...', 'info');
                await stopAllNDI();
                await stage.leave();
                stage = null; participants.clear(); participantStreams.clear(); ndiEnabled.clear(); ndiCapture.clear();
                document.getElementById('videoGrid').innerHTML = `<div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg><p class="empty-state-text">D√©connect√©</p></div>`;
                updateParticipantCount(); updateStatus('DISCONNECTED'); updateNDIPanel();
                document.getElementById('currentUser').textContent = '';
                log('‚úÖ D√©connect√©', 'success');
            } catch (error) { log(`‚ùå ${error.message}`, 'error'); }
        }

        window.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', () => { if (stage) disconnectFromStage(); });
    </script>
</body>
</html>
