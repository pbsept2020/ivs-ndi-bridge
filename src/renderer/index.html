<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://web-broadcast.live-video.net; style-src 'self' 'unsafe-inline'; connect-src https://*.amazonaws.com wss://*.live-video.net https://*.live-video.net;">
    <title>IVS-NDI Bridge</title>
    <script src="https://web-broadcast.live-video.net/1.24.0/amazon-ivs-web-broadcast.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0f1419;
            color: #e1e8ed;
        }
        
        .titlebar {
            -webkit-app-region: drag;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #1e2732 0%, #0f1419 100%);
            border-bottom: 1px solid #536471;
            padding-left: 80px;
            margin: -20px -20px 20px -20px;
        }
        .titlebar * { -webkit-app-region: no-drag; }
        .titlebar-title { font-size: 13px; font-weight: 500; color: #8b98a5; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 { color: #1d9bf0; margin-bottom: 30px; text-align: center; }
        
        /* NDI Status Panel */
        .ndi-panel {
            background: linear-gradient(135deg, #0a2a1a, #0f1419);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #00d4aa;
        }
        .ndi-panel h3 {
            color: #00d4aa;
            margin: 0 0 12px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ndi-status-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .ndi-sender-card {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            min-width: 200px;
        }
        .ndi-sender-name { color: #00d4aa; font-weight: 600; font-size: 13px; }
        .ndi-sender-stats { color: #8b98a5; font-size: 11px; margin-top: 4px; }
        .ndi-empty { color: #536471; font-size: 13px; font-style: italic; }

        /* API Panel */
        .api-panel {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #9147ff;
        }
        .api-panel h3 { color: #9147ff; margin-top: 0; margin-bottom: 15px; }
        .api-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .api-row > div { flex: 1; }
        .api-row label { display: block; margin-bottom: 5px; font-size: 12px; color: #8b98a5; }
        .api-row select, .api-row input {
            width: 100%;
            padding: 10px;
            border: 1px solid #536471;
            border-radius: 8px;
            background-color: #0f1419;
            color: #e1e8ed;
            font-size: 14px;
        }
        .api-row select:focus, .api-row input:focus { outline: none; border-color: #9147ff; }
        .api-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .api-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-generate { background: linear-gradient(135deg, #9147ff, #6441a5); color: white; }
        .btn-generate:hover:not(:disabled) { background: linear-gradient(135deg, #a855f7, #7c3aed); transform: translateY(-1px); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-connect-auto { background: linear-gradient(135deg, #00ba7c, #00875a); color: white; }
        .btn-connect-auto:hover:not(:disabled) { background: linear-gradient(135deg, #00d68f, #00a06a); transform: translateY(-1px); }
        .btn-connect-auto:disabled { opacity: 0.5; cursor: not-allowed; }
        .api-status { text-align: center; padding: 10px; border-radius: 8px; margin-top: 12px; font-size: 13px; }
        .api-status.success { background-color: rgba(0, 186, 124, 0.2); color: #00ba7c; border: 1px solid #00ba7c; }
        .api-status.error { background-color: rgba(249, 24, 128, 0.2); color: #f91880; border: 1px solid #f91880; }
        .api-status.loading { background-color: rgba(29, 155, 240, 0.2); color: #1d9bf0; border: 1px solid #1d9bf0; }
        .api-config-toggle { color: #9147ff; cursor: pointer; font-size: 12px; margin-top: 10px; display: inline-block; }
        .api-config-toggle:hover { text-decoration: underline; }
        .api-config { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #536471; }
        .api-config.show { display: block; }
        .duration-presets { display: flex; gap: 5px; margin-top: 8px; }
        .duration-presets button { flex: 1; padding: 6px; font-size: 11px; background: #536471; color: white; border: none; border-radius: 15px; cursor: pointer; }
        .duration-presets button:hover { background: #6b7785; }
        .duration-presets button.active { background: #9147ff; }
        
        .status-bar {
            background-color: #1e2732;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status { display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: #536471; }
        .status-indicator.connected { background-color: #00ba7c; animation: pulse 2s infinite; }
        .status-indicator.connecting { background-color: #ffd400; animation: pulse 1s infinite; }
        .status-indicator.error { background-color: #f91880; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-container {
            background-color: #1e2732;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
            min-height: 300px;
            border: 2px solid transparent;
        }
        .video-container.combined { border: 2px solid #00ba7c; box-shadow: 0 0 20px rgba(0, 186, 124, 0.3); }
        .video-container.ndi-active { border: 2px solid #00d4aa; box-shadow: 0 0 25px rgba(0, 212, 170, 0.4); }
        .video-container video { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        
        .participant-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .audio-indicator {
            width: 16px;
            height: 16px;
            background-color: #536471;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .audio-indicator.active { background-color: #00ba7c; animation: pulse 1s infinite; }
        
        .quality-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #00ba7c;
        }
        
        .ndi-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #00d4aa, #00a080);
            color: #000;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: none;
            animation: ndi-glow 2s infinite;
        }
        .ndi-badge.active { display: block; }
        .ndi-badge .fps { font-weight: normal; margin-left: 5px; }
        @keyframes ndi-glow { 0%, 100% { box-shadow: 0 0 5px rgba(0, 212, 170, 0.5); } 50% { box-shadow: 0 0 15px rgba(0, 212, 170, 0.8); } }
        
        .video-overlay-controls {
            position: absolute;
            bottom: 50px;
            left: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .video-container:hover .video-overlay-controls { opacity: 1; }
        .video-overlay-controls button {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .video-overlay-controls button:hover { background: rgba(0, 0, 0, 0.9); transform: scale(1.05); }
        .video-overlay-controls button.ndi-btn { background: rgba(0, 212, 170, 0.3); border: 1px solid #00d4aa; }
        .video-overlay-controls button.ndi-btn:hover { background: rgba(0, 212, 170, 0.5); }
        .video-overlay-controls button.ndi-btn.active { background: #00d4aa; color: #000; }
        
        .controls {
            background-color: #1e2732;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background-color: #1d9bf0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover { background-color: #1a8cd8; }
        button:disabled { background-color: #536471; cursor: not-allowed; }
        .btn-ndi { background: linear-gradient(135deg, #00d4aa, #00a080); color: #000; font-weight: 600; }
        .btn-ndi:hover:not(:disabled) { background: linear-gradient(135deg, #00e4ba, #00b090); }
        .btn-danger { background-color: #f91880; }
        .btn-danger:hover:not(:disabled) { background-color: #e01670; }
        
        .log-panel {
            background-color: #1e2732;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }
        .log-entry { font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; margin-bottom: 5px; padding: 5px; border-radius: 5px; }
        .log-entry.info { color: #1d9bf0; }
        .log-entry.success { color: #00ba7c; }
        .log-entry.error { color: #f91880; background-color: rgba(249, 24, 128, 0.1); }
        .log-entry.warning { color: #ffd400; }
        .log-entry.ndi { color: #00d4aa; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #536471; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; fill: #536471; }
        
        .platform-info { display: flex; gap: 10px; font-size: 11px; color: #536471; margin-bottom: 15px; }
        .platform-info span { background: #1e2732; padding: 4px 8px; border-radius: 4px; }
        .platform-info .ndi-status { background: rgba(0, 212, 170, 0.2); color: #00d4aa; border: 1px solid rgba(0, 212, 170, 0.3); }
        .platform-info .ndi-status.error { background: rgba(249, 24, 128, 0.2); color: #f91880; border: 1px solid rgba(249, 24, 128, 0.3); }
    </style>
</head>
<body>
    <div class="titlebar">
        <span class="titlebar-title">IVS-NDI Bridge</span>
    </div>
    
    <div class="container">
        <h1>üé¨ IVS-NDI Bridge <small style="font-size: 14px; color: #00d4aa;">NDI Output</small></h1>
        
        <div class="platform-info" id="platformInfo">
            <span>Chargement...</span>
        </div>
        
        <div class="ndi-panel">
            <h3>üì° Sorties NDI</h3>
            <div class="ndi-status-grid" id="ndiStatusGrid">
                <span class="ndi-empty">Connectez-vous √† un stage pour activer les sorties NDI</span>
            </div>
        </div>
        
        <div class="api-panel">
            <h3>‚ö° Connexion au Stage</h3>
            <div class="api-row">
                <div>
                    <label for="stageSelect">Stage</label>
                    <select id="stageSelect">
                        <option value="">-- Chargement des stages... --</option>
                    </select>
                </div>
                <div style="flex: 0.6;">
                    <label for="userIdInput">User ID</label>
                    <input type="text" id="userIdInput" placeholder="bridge-operator" value="bridge-operator">
                </div>
            </div>
            
            <span class="api-config-toggle" onclick="toggleApiConfig()">‚öôÔ∏è Options avanc√©es</span>
            
            <div id="apiConfig" class="api-config">
                <div class="api-row">
                    <div>
                        <label for="durationInput">Dur√©e du token (minutes)</label>
                        <input type="number" id="durationInput" value="120" min="1" max="1440">
                        <div class="duration-presets">
                            <button onclick="setDuration(60)">1h</button>
                            <button onclick="setDuration(120)" class="active">2h</button>
                            <button onclick="setDuration(240)">4h</button>
                            <button onclick="setDuration(480)">8h</button>
                        </div>
                    </div>
                    <div>
                        <label for="apiUrlInput">URL de l'API</label>
                        <input type="text" id="apiUrlInput" value="https://8o76zphwpa.execute-api.eu-central-1.amazonaws.com/prod">
                    </div>
                </div>
            </div>
            
            <div class="api-buttons">
                <button class="btn-generate" onclick="generateTokenFromApi()" id="btnGenerate">
                    üé´ G√©n√©rer Token
                </button>
                <button class="btn-connect-auto" onclick="generateAndConnect()" id="btnGenerateConnect" disabled>
                    üöÄ Connecter
                </button>
            </div>
            
            <div id="apiStatus" class="api-status" style="display: none;"></div>
        </div>
        
        <div class="status-bar">
            <div class="status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">D√©connect√©</span>
                <span id="currentUser" style="margin-left: 20px; color: #8b98a5;"></span>
            </div>
            <div>
                <span id="participantCount">0 participant(s)</span>
            </div>
        </div>
        
        <div id="videoGrid" class="video-grid">
            <div class="empty-state">
                <svg viewBox="0 0 24 24">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                <p>Connectez-vous √† un stage IVS</p>
                <p style="font-size: 12px; margin-top: 8px;">Les participants seront disponibles en sortie NDI</p>
            </div>
        </div>
        
        <div class="controls">
            <button id="disconnectBtn" onclick="disconnectFromStage()" disabled class="btn-danger">Se d√©connecter</button>
            <button class="btn-ndi" onclick="startAllNDI()" id="startAllNdiBtn" disabled>üì° Activer tous les NDI</button>
            <button onclick="stopAllNDI()">‚èπ Arr√™ter tous les NDI</button>
            <button onclick="clearLogs()">üßπ Effacer logs</button>
        </div>
        
        <div class="log-panel" id="logPanel"></div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_BASE_URL = 'https://8o76zphwpa.execute-api.eu-central-1.amazonaws.com/prod';
        const NDI_TARGET_FPS = 30;
        const NDI_FRAME_INTERVAL = 1000 / NDI_TARGET_FPS;
        
        let availableStages = [];
        
        // State
        let currentToken = null;
        let tokenPayload = null;
        let stage = null;
        let participants = new Map();
        let participantStreams = new Map();
        let ndiEnabled = new Map();      // participantId -> boolean
        let ndiCapture = new Map();      // participantId -> { canvas, ctx, animationId, frameCount, startTime }
        let ndiAvailable = false;
        
        // ==================== INITIALIZATION ====================
        
        async function init() {
            log('üöÄ IVS-NDI Bridge d√©marr√©', 'info');
            
            if (window.bridge) {
                const platform = window.bridge.platform;
                document.getElementById('platformInfo').innerHTML = `
                    <span>Electron ${platform.versions.electron}</span>
                    <span>Chrome ${platform.versions.chrome}</span>
                    <span>${platform.os} ${platform.arch}</span>
                    <span class="ndi-status" id="ndiStatusBadge">NDI: Initialisation...</span>
                `;
                
                log('üì° Initialisation NDI...', 'ndi');
                try {
                    ndiAvailable = await window.bridge.ndi.init();
                    if (ndiAvailable) {
                        log('‚úÖ NDI pr√™t - Grandiose charg√©', 'ndi');
                        document.getElementById('ndiStatusBadge').textContent = 'NDI: Pr√™t ‚úì';
                    } else {
                        log('‚ö†Ô∏è NDI non disponible', 'warning');
                        document.getElementById('ndiStatusBadge').textContent = 'NDI: Non disponible';
                        document.getElementById('ndiStatusBadge').classList.add('error');
                    }
                } catch (err) {
                    log(`‚ùå Erreur init NDI: ${err.message}`, 'error');
                    document.getElementById('ndiStatusBadge').textContent = 'NDI: Erreur';
                    document.getElementById('ndiStatusBadge').classList.add('error');
                }
            } else {
                log('‚ö†Ô∏è Mode navigateur - NDI d√©sactiv√©', 'warning');
                document.getElementById('platformInfo').innerHTML = `
                    <span>Mode Web</span>
                    <span class="ndi-status error">NDI: Non disponible (Electron requis)</span>
                `;
            }
            
            await loadStages();
            
            setTimeout(() => {
                if (typeof IVSBroadcastClient !== 'undefined') {
                    log('‚úÖ SDK IVS charg√©', 'success');
                } else {
                    log('‚ùå SDK IVS non trouv√©', 'error');
                }
            }, 500);
        }
        
        // ==================== LOGGING ====================
        
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[IVS-NDI] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('logPanel').innerHTML = '';
            log('üßπ Logs effac√©s', 'info');
        }
        
        // ==================== API FUNCTIONS ====================
        
        function getApiUrl() {
            return document.getElementById('apiUrlInput')?.value || API_BASE_URL;
        }
        
        function showApiStatus(message, type) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = 'api-status ' + type;
            status.style.display = 'block';
        }
        
        function toggleApiConfig() {
            document.getElementById('apiConfig').classList.toggle('show');
        }
        
        function setDuration(minutes) {
            document.getElementById('durationInput').value = minutes;
            document.querySelectorAll('.duration-presets button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        async function loadStages() {
            try {
                log('üì° Chargement des stages...', 'info');
                const response = await fetch(`${getApiUrl()}/stages`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                availableStages = data.stages || [];
                
                const select = document.getElementById('stageSelect');
                select.innerHTML = '<option value="">-- S√©lectionnez un stage --</option>';
                
                availableStages.forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage.arn;
                    option.textContent = `${stage.name} (${stage.activeSessionId ? 'üü¢ Actif' : '‚ö™ Inactif'})`;
                    select.appendChild(option);
                });
                
                log(`‚úÖ ${availableStages.length} stage(s) disponible(s)`, 'success');
                document.getElementById('btnGenerateConnect').disabled = false;
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                document.getElementById('stageSelect').innerHTML = '<option value="">‚ùå Erreur chargement</option>';
            }
        }
        
        async function generateTokenFromApi() {
            const stageArn = document.getElementById('stageSelect').value;
            if (!stageArn) {
                showApiStatus('‚ö†Ô∏è S√©lectionnez un stage', 'error');
                return null;
            }
            
            const userId = document.getElementById('userIdInput').value.trim() || 'bridge-operator';
            const duration = parseInt(document.getElementById('durationInput').value) || 120;
            
            try {
                showApiStatus('‚è≥ G√©n√©ration du token...', 'loading');
                document.getElementById('btnGenerate').disabled = true;
                
                const response = await fetch(`${getApiUrl()}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stageArn, userId, duration })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                currentToken = data.token;
                
                const parts = currentToken.split('.');
                tokenPayload = JSON.parse(atob(parts[1]));
                
                showApiStatus(`‚úÖ Token g√©n√©r√© (${duration} min)`, 'success');
                log(`üé´ Token: ${userId}`, 'success');
                
                document.getElementById('currentUser').textContent = `(${userId})`;
                
                return data.token;
                
            } catch (error) {
                showApiStatus(`‚ùå ${error.message}`, 'error');
                log(`‚ùå ${error.message}`, 'error');
                return null;
            } finally {
                document.getElementById('btnGenerate').disabled = false;
            }
        }
        
        async function generateAndConnect() {
            const token = await generateTokenFromApi();
            if (token) {
                setTimeout(() => connectToStage(), 100);
            }
        }
        
        // ==================== UI UPDATES ====================
        
        function updateStatus(state) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.classList.remove('connected', 'connecting', 'error');
            
            switch(state) {
                case 'CONNECTED':
                    indicator.classList.add('connected');
                    text.textContent = 'Connect√©';
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('startAllNdiBtn').disabled = false;
                    break;
                case 'CONNECTING':
                    indicator.classList.add('connecting');
                    text.textContent = 'Connexion...';
                    break;
                case 'DISCONNECTED':
                    text.textContent = 'D√©connect√©';
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('startAllNdiBtn').disabled = true;
                    break;
                case 'ERROR':
                    indicator.classList.add('error');
                    text.textContent = 'Erreur';
                    break;
            }
        }
        
        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = `${participants.size} participant(s)`;
        }
        
        function updateNDIPanel() {
            const grid = document.getElementById('ndiStatusGrid');
            const activeNDI = [];
            
            ndiEnabled.forEach((enabled, participantId) => {
                if (enabled) {
                    const participant = participants.get(participantId);
                    const capture = ndiCapture.get(participantId);
                    const fps = capture ? Math.round(capture.frameCount / ((Date.now() - capture.startTime) / 1000)) : 0;
                    activeNDI.push({
                        id: participantId,
                        name: participant?.userId || participantId.slice(0, 8),
                        fps: fps,
                        frames: capture?.frameCount || 0
                    });
                }
            });
            
            if (activeNDI.length === 0) {
                grid.innerHTML = '<span class="ndi-empty">Aucune sortie NDI active - Survolez une vid√©o et cliquez sur üì°</span>';
            } else {
                grid.innerHTML = activeNDI.map(ndi => `
                    <div class="ndi-sender-card">
                        <div class="ndi-sender-name">IVS-${ndi.name}</div>
                        <div class="ndi-sender-stats">${ndi.frames} frames ‚Ä¢ ${ndi.fps} fps</div>
                    </div>
                `).join('');
            }
        }
        
        // ==================== NDI FRAME CAPTURE ====================
        
        /**
         * Start capturing frames from a video element and sending to NDI
         * Phase 1: Canvas capture with RGBA‚ÜíBGRA conversion (has memory copies)
         * Phase 2: Will use native module for zero-copy
         */
        function startFrameCapture(participantId) {
            const container = document.getElementById(`video-${participantId}-combined`);
            if (!container) {
                log(`‚ùå Container vid√©o non trouv√©: ${participantId}`, 'error');
                return false;
            }
            
            const video = container.querySelector('video');
            if (!video || video.readyState < 2) {
                log(`‚ö†Ô∏è Vid√©o pas pr√™te: ${participantId}`, 'warning');
                return false;
            }
            
            // Create offscreen canvas for frame capture
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { 
                willReadFrequently: true,
                alpha: false 
            });
            
            // Set canvas size to video dimensions
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            
            log(`üìê Capture: ${canvas.width}x${canvas.height}`, 'ndi');
            
            const captureState = {
                canvas,
                ctx,
                video,
                frameCount: 0,
                startTime: Date.now(),
                lastFrameTime: 0,
                intervalId: null  // Changed from animationId
            };
            
            ndiCapture.set(participantId, captureState);
            
            // Start capture loop using setInterval for consistent timing
            // (requestAnimationFrame can behave differently in fullscreen)
            function captureFrame() {
                if (!ndiEnabled.get(participantId)) {
                    return; // Stop if NDI disabled
                }
                
                const state = ndiCapture.get(participantId);
                if (!state) return;
                
                // Update canvas size if video changed
                if (state.video.videoWidth && state.canvas.width !== state.video.videoWidth) {
                    state.canvas.width = state.video.videoWidth;
                    state.canvas.height = state.video.videoHeight;
                }
                
                // Draw video frame to canvas
                state.ctx.drawImage(state.video, 0, 0, state.canvas.width, state.canvas.height);
                
                // Get pixel data (RGBA format) - envoy√© directement sans conversion
                // Le main process utilise FOURCC_RGBX qui accepte RGBA natif
                // √âvite 3.6M op√©rations par frame (720p) qui tuaient le fps
                const imageData = state.ctx.getImageData(0, 0, state.canvas.width, state.canvas.height);
                
                // Send to main process via IPC - RGBA direct
                window.bridge.ndi.sendFrame(participantId, {
                    width: state.canvas.width,
                    height: state.canvas.height,
                    data: new Uint8Array(imageData.data.buffer)
                });
                
                state.frameCount++;
                
                // Update FPS display every 30 frames
                if (state.frameCount % 30 === 0) {
                    const badge = document.getElementById(`ndi-badge-${participantId}`);
                    const fps = Math.round(state.frameCount / ((Date.now() - state.startTime) / 1000));
                    if (badge) {
                        badge.innerHTML = `üì° NDI <span class="fps">${fps} fps</span>`;
                    }
                    updateNDIPanel();
                }
            }
            
            // Use setInterval at 40ms = 25fps (matching IVS source)
            captureState.intervalId = setInterval(captureFrame, 40);
            
            log(`‚ñ∂Ô∏è Capture d√©marr√©e: ${participantId.slice(0, 8)}`, 'ndi');
            return true;
        }
        
        function stopFrameCapture(participantId) {
            const state = ndiCapture.get(participantId);
            if (state) {
                if (state.animationId) {
                    cancelAnimationFrame(state.animationId);
                }
                const fps = Math.round(state.frameCount / ((Date.now() - state.startTime) / 1000));
                log(`‚èπ Capture arr√™t√©e: ${state.frameCount} frames, ${fps} fps moyen`, 'ndi');
                ndiCapture.delete(participantId);
            }
        }
        
        // ==================== NDI CONTROL ====================
        
        async function toggleNDI(participantId) {
            const isEnabled = ndiEnabled.get(participantId);
            const participant = participants.get(participantId);
            const displayName = participant?.userId || participantId.slice(0, 8);
            
            if (!window.bridge) {
                log('‚ö†Ô∏è NDI non disponible (mode web)', 'warning');
                return;
            }
            
            if (!ndiAvailable) {
                log('‚ö†Ô∏è NDI non initialis√©', 'warning');
                return;
            }
            
            const ndiBtn = document.getElementById(`ndi-btn-${participantId}`);
            const ndiBadge = document.getElementById(`ndi-badge-${participantId}`);
            const container = document.getElementById(`video-${participantId}-combined`);
            
            if (isEnabled) {
                // Stop NDI
                try {
                    stopFrameCapture(participantId);
                    await window.bridge.ndi.removeSender(participantId);
                    ndiEnabled.set(participantId, false);
                    
                    ndiBtn?.classList.remove('active');
                    ndiBadge?.classList.remove('active');
                    container?.classList.remove('ndi-active');
                    
                    log(`‚èπ NDI arr√™t√©: ${displayName}`, 'ndi');
                } catch (err) {
                    log(`‚ùå Erreur arr√™t NDI: ${err.message}`, 'error');
                }
            } else {
                // Start NDI
                try {
                    const senderName = await window.bridge.ndi.createSender(participantId, displayName);
                    if (senderName) {
                        ndiEnabled.set(participantId, true);
                        
                        ndiBtn?.classList.add('active');
                        ndiBadge?.classList.add('active');
                        container?.classList.add('ndi-active');
                        
                        // Start frame capture
                        const captureStarted = startFrameCapture(participantId);
                        if (captureStarted) {
                            log(`üì° NDI d√©marr√©: ${senderName}`, 'ndi');
                        } else {
                            log(`‚ö†Ô∏è NDI cr√©√© mais capture √©chou√©e`, 'warning');
                        }
                    } else {
                        log(`‚ùå √âchec cr√©ation NDI`, 'error');
                    }
                } catch (err) {
                    log(`‚ùå Erreur cr√©ation NDI: ${err.message}`, 'error');
                }
            }
            
            updateNDIPanel();
        }
        
        async function startAllNDI() {
            log('üì° Activation de tous les NDI...', 'ndi');
            
            for (const [participantId] of participants) {
                if (!ndiEnabled.get(participantId)) {
                    await toggleNDI(participantId);
                    await new Promise(r => setTimeout(r, 200));
                }
            }
        }
        
        async function stopAllNDI() {
            log('‚èπ Arr√™t de tous les NDI...', 'ndi');
            
            for (const [participantId] of participants) {
                if (ndiEnabled.get(participantId)) {
                    await toggleNDI(participantId);
                }
            }
        }
        
        // ==================== VIDEO ELEMENTS ====================
        
        function combineStreams(participantId) {
            const streams = participantStreams.get(participantId);
            if (!streams || streams.combined) return streams?.combined;
            
            if (streams.audio && streams.video) {
                try {
                    const combinedStream = new MediaStream();
                    streams.video.getVideoTracks().forEach(track => combinedStream.addTrack(track));
                    streams.audio.getAudioTracks().forEach(track => combinedStream.addTrack(track));
                    streams.combined = combinedStream;
                    
                    removeIndividualVideoContainers(participantId);
                    createCombinedVideoElement(participantId, combinedStream);
                    
                    log(`‚úÖ Stream combin√©: ${participantId.slice(0, 8)}`, 'success');
                    return combinedStream;
                } catch (error) {
                    log(`‚ùå Erreur combinaison: ${error.message}`, 'error');
                }
            }
            return null;
        }
        
        function removeIndividualVideoContainers(participantId) {
            ['audio', 'video'].forEach(type => {
                const el = document.getElementById(`video-${participantId}-${type}`);
                if (el) el.remove();
            });
        }
        
        function createCombinedVideoElement(participantId, combinedStream) {
            const participant = participants.get(participantId);
            const container = document.createElement('div');
            container.className = 'video-container combined';
            container.id = `video-${participantId}-combined`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.muted = true;
            
            const ndiBadge = document.createElement('div');
            ndiBadge.className = 'ndi-badge';
            ndiBadge.id = `ndi-badge-${participantId}`;
            ndiBadge.textContent = 'üì° NDI';
            
            const overlayControls = document.createElement('div');
            overlayControls.className = 'video-overlay-controls';
            
            const ndiBtn = document.createElement('button');
            ndiBtn.className = 'ndi-btn';
            ndiBtn.id = `ndi-btn-${participantId}`;
            ndiBtn.innerHTML = 'üì° NDI';
            ndiBtn.title = 'Activer la sortie NDI';
            ndiBtn.onclick = (e) => {
                e.stopPropagation();
                toggleNDI(participantId);
            };
            overlayControls.appendChild(ndiBtn);
            
            const qualityIndicator = document.createElement('div');
            qualityIndicator.className = 'quality-indicator';
            qualityIndicator.textContent = 'HD';
            
            const label = document.createElement('div');
            label.className = 'participant-label';
            
            const audioIndicator = document.createElement('div');
            audioIndicator.className = 'audio-indicator active';
            audioIndicator.innerHTML = 'üîä';
            
            const displayName = participant?.userId || participantId.slice(0, 8);
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = displayName;
            
            label.appendChild(audioIndicator);
            label.appendChild(nameSpan);
            
            container.appendChild(video);
            container.appendChild(ndiBadge);
            container.appendChild(overlayControls);
            container.appendChild(qualityIndicator);
            container.appendChild(label);
            
            video.srcObject = combinedStream;
            
            video.addEventListener('loadedmetadata', () => {
                qualityIndicator.textContent = video.videoHeight >= 720 ? 'HD' : 'SD';
                log(`üì∫ R√©solution: ${video.videoWidth}x${video.videoHeight}`, 'info');
            });
            
            video.play().catch(err => {
                container.style.cursor = 'pointer';
                container.addEventListener('click', () => video.play(), { once: true });
            });
            
            const grid = document.getElementById('videoGrid');
            if (grid.querySelector('.empty-state')) {
                grid.innerHTML = '';
            }
            grid.appendChild(container);
            
            ndiEnabled.set(participantId, false);
            
            return container;
        }
        
        function createVideoElement(participantId, mediaStream, userId, streamType) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `video-${participantId}-${streamType}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.muted = true;
            
            const label = document.createElement('div');
            label.className = 'participant-label';
            
            const audioIndicator = document.createElement('div');
            audioIndicator.className = `audio-indicator ${streamType === 'audio' ? 'active' : ''}`;
            audioIndicator.innerHTML = streamType === 'audio' ? 'üîä' : 'üé•';
            
            const displayName = `${userId || participantId.slice(0, 8)} [${streamType}]`;
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = displayName;
            
            label.appendChild(audioIndicator);
            label.appendChild(nameSpan);
            
            container.appendChild(video);
            container.appendChild(label);
            
            video.srcObject = mediaStream;
            video.play().catch(() => {});
            
            return container;
        }
        
        // ==================== STAGE MANAGEMENT ====================
        
        async function connectToStage() {
            if (!currentToken) {
                log('‚ùå Aucun token', 'error');
                return;
            }
            
            if (typeof IVSBroadcastClient === 'undefined') {
                log('‚ùå SDK IVS non disponible', 'error');
                return;
            }
            
            try {
                log('üîå Connexion au stage...', 'info');
                updateStatus('CONNECTING');
                
                const strategy = {
                    stageStreamsToPublish: () => [],
                    shouldPublishParticipant: () => false,
                    shouldSubscribeToParticipant: (participant) => {
                        return IVSBroadcastClient.SubscribeType.AUDIO_VIDEO;
                    }
                };
                
                stage = new IVSBroadcastClient.Stage(currentToken, strategy);
                
                stage.on(IVSBroadcastClient.StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => {
                    log(`üì° ${state}`, 'info');
                    updateStatus(state);
                });
                
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_JOINED, (participant) => {
                    log(`‚úÖ ${participant.userId || participant.id} a rejoint`, 'success');
                    participants.set(participant.id, participant);
                    
                    if (!participantStreams.has(participant.id)) {
                        participantStreams.set(participant.id, { audio: null, video: null, combined: null });
                    }
                    
                    updateParticipantCount();
                });
                
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_LEFT, (participant) => {
                    log(`üëã ${participant.userId || participant.id} est parti`, 'warning');
                    
                    // Stop NDI and capture
                    if (ndiEnabled.get(participant.id)) {
                        stopFrameCapture(participant.id);
                        if (window.bridge) {
                            window.bridge.ndi.removeSender(participant.id);
                        }
                    }
                    
                    participants.delete(participant.id);
                    participantStreams.delete(participant.id);
                    ndiEnabled.delete(participant.id);
                    ndiCapture.delete(participant.id);
                    
                    document.querySelectorAll(`[id^="video-${participant.id}"]`).forEach(el => el.remove());
                    updateParticipantCount();
                    updateNDIPanel();
                    
                    if (participants.size === 0) {
                        document.getElementById('videoGrid').innerHTML = `
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                                </svg>
                                <p>En attente de participants...</p>
                            </div>
                        `;
                    }
                });
                
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED, (participant, streams) => {
                    log(`üé• Flux de ${participant.userId || participant.id}: ${streams.length} stream(s)`, 'info');
                    
                    const grid = document.getElementById('videoGrid');
                    if (grid.querySelector('.empty-state')) {
                        grid.innerHTML = '';
                    }
                    
                    streams.forEach((stream) => {
                        const mediaStreamTrack = stream.mediaStreamTrack;
                        if (!mediaStreamTrack) return;
                        
                        const mediaStream = new MediaStream([mediaStreamTrack]);
                        const streamType = mediaStreamTrack.kind;
                        
                        log(`üé¨ Track ${streamType}: ${mediaStreamTrack.label}`, 'info');
                        
                        const data = participantStreams.get(participant.id) || { audio: null, video: null, combined: null };
                        data[streamType] = mediaStream;
                        participantStreams.set(participant.id, data);
                        
                        const videoElement = createVideoElement(participant.id, mediaStream, participant.userId, streamType);
                        grid.appendChild(videoElement);
                    });
                    
                    setTimeout(() => {
                        const streamData = participantStreams.get(participant.id);
                        if (streamData?.audio && streamData?.video && !streamData?.combined) {
                            combineStreams(participant.id);
                        }
                    }, 1500);
                });
                
                stage.on(IVSBroadcastClient.StageEvents.STAGE_PARTICIPANT_STREAMS_REMOVED, (participant, streams) => {
                    log(`üóëÔ∏è Streams supprim√©s: ${participant.id}`, 'warning');
                    
                    streams.forEach(stream => {
                        const streamType = stream.mediaStreamTrack?.kind;
                        document.getElementById(`video-${participant.id}-${streamType}`)?.remove();
                    });
                    
                    document.getElementById(`video-${participant.id}-combined`)?.remove();
                });
                
                stage.on(IVSBroadcastClient.StageEvents.ERROR, (error) => {
                    log(`‚ùå ${error.message || error}`, 'error');
                    updateStatus('ERROR');
                });
                
                await stage.join();
                
            } catch (error) {
                log(`‚ùå Connexion: ${error.message}`, 'error');
                updateStatus('ERROR');
            }
        }
        
        async function disconnectFromStage() {
            if (!stage) return;
            
            try {
                log('üîå D√©connexion...', 'info');
                
                await stopAllNDI();
                
                await stage.leave();
                stage = null;
                participants.clear();
                participantStreams.clear();
                ndiEnabled.clear();
                ndiCapture.clear();
                
                document.getElementById('videoGrid').innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24">
                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <p>D√©connect√©</p>
                    </div>
                `;
                
                updateParticipantCount();
                updateStatus('DISCONNECTED');
                updateNDIPanel();
                
                document.getElementById('currentUser').textContent = '';
                
                log('‚úÖ D√©connect√©', 'success');
                
            } catch (error) {
                log(`‚ùå ${error.message}`, 'error');
            }
        }
        
        // ==================== INIT ====================
        
        window.addEventListener('DOMContentLoaded', init);
        
        window.addEventListener('beforeunload', () => {
            if (stage) disconnectFromStage();
        });
    </script>
</body>
</html>
